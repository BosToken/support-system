(function(a){a.extend({appsbdChat:function(f){var o=a("body"),D,u,x,p,d,q,l,v,B,w,g,e;var h=this;var A=a.extend({url:"",chatKey:"",theme:"",buttonIcon:"ap ap-chat2",chatTitle:"Unknown Title",chatSubTitle:"Unknown Sub Title",chatLogo:"",preMsg:"Start by click the button",startBtnText:"Start Conversation",chatBtnSelector:"#apbd-cht-btn",chatWindowSelector:"#apbd-cht-conversation",inputBoxSelector:"#apbd-cht-input",msgContainerSelector:".apc-msgs",closeBtnSelector:".apc-header-close-window",soundBtnSelector:".apc-header-sound",sendBtnSelector:".apc-send-btn",attachBtnSelector:".apc-attach-btn",typingSelector:".apc-msg-typing",startBtnSelector:"#apc-start-chat-btn",soundMuteIcon:"ap ap-volume-mute2",soundEnableIcon:"ap ap-volume-high",systemSingleMsgContainer:"#apc-system-single-msg",fileStatusViewerElem:".apc-file-up-status",clientImg:"",onInit:function(E){},hasStartForm:false,defaultClientImage:"",ajaxSender:null,maxHeight:450,checkInterval:5000,audioPath:"",isDisableFileUpload:false,fileUrl:"",fileAccepts:"*",soundEnable:true,maxFileSize:"2",maxFileErrorMsgTitle:"Large File Error",maxFileErrorMsg:"Max file size is  %s MB",unsupportedFileMsgTitle:"File Error",unsupportedFileMsg:"Uploaded file is not  supported",loadMoreText:"Load More"},f);var C="apcweb-";var z={isOpened:false,id:"sarwa",chatId:"",last_temp_id:1,clientIdPrefix:"apcweb-",clientImg:A.clientImg,clientId:"",enableSound:true};var j={id:"",temp_id:"",msg_html:"",msg_time:"",chatId:"",senderType:"",senderImg:""};var k="";if(A.theme!=""){k=A.theme}else{k='<div id="apbd-cht-container">\n    <div id="apbd-cht-conversation" class="apc-msg-window apc-ct-not-ready apc-not-started">\n        <div class="apc-alert-msg"></div>        <button class="apc-header-sound apc-enable">\n            <i class="ap ap-volume-high"></i>        </button>\n        <button class="apc-header-close-window">\n            <svg style="height: 15px;width: 15px;"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-340.000000, -32.000000)" fill="#FFFFFF"><polygon points="350.656537 44 346 39.343463 341.343463 44 340 42.656537 344.656537 38 340 33.343463 341.343463 32 346 36.656537 350.656537 32 352 33.343463 347.343463 38 352 42.656537"></polygon></g></g></svg>\n        </button>\n        <div class="apc-header">\n            <div class="apc-header-row">\n                <div class="apc-company-img">\n                    <img src="'+A.chatLogo+'" alt="Logo">\n                </div>\n                <div class="apc-header-info">\n                    <div class="apc-header-info-title">'+A.chatTitle+'</div>\n                    <div class="apc-header-info-tag-line">'+A.chatSubTitle+'</div>\n                </div>\n\n            </div>\n\n        </div>\n        <div id="apc-system-single-msg" class="apc-system-single-msg">\n            <div class="apc-msg">\n                \n            </div>\n        </div>\n        <div class="apc-msgs">\n             <div class="apc-load-move text-center"><button class="btn btn-xs btn-info"><i class="fa fa-arrow-circle-o-down"></i> '+A.loadMoreText+'</button></div>            \n        </div>\n        <div class="apc-type-container" >\n            <div class="apc-msg-typing">\n                <div class="apc-spinner">\n                    <div class="apc-bounce1"></div>\n                    <div class="apc-bounce2"></div>\n                    <div class="apc-bounce3"></div>\n                </div>\n                typing\n            </div>\n            <div class="apc-file-up-status"></div>            <textarea  id="apbd-cht-input" placeholder="Send a message.." class="apc-chat-input"></textarea>\n            <div class="apc-send-ctrl">\n                <i class="apc-attach-btn fa fa-paperclip"></i>\n                <i class="apc-send-btn fa fa-send"></i>\n            </div>\n        </div>\n        <div class="apc-start text-center">\n            <p class="text-center">\n                '+A.preMsg+'.\n            </p>\n            <button id="apc-start-chat-btn" class="btn btn-success">'+A.startBtnText+' </button>\n        </div>\n    </div>\n    <div id="apbd-cht-btn" class="apc-main-icon">\n        <i class="'+A.buttonIcon+'"></i>\n    </div>\n</div>'}chatMainElem=a(k);a(o).append(chatMainElem);var s=false;var c=false;x=a("#apbd_cht_container");d=a(A.chatWindowSelector);q=chatMainElem.find(A.msgContainerSelector);l=chatMainElem.find(A.inputBoxSelector);var i=chatMainElem.find(".apc-type-container");gcl(i);p=chatMainElem.find(A.closeBtnSelector);v=chatMainElem.find(A.chatBtnSelector);B=chatMainElem.find(A.sendBtnSelector);w=chatMainElem.find(A.attachBtnSelector);g=chatMainElem.find(A.typingSelector);e=chatMainElem.find(A.startBtnSelector);D=chatMainElem.find(A.systemSingleMsgContainer);u=chatMainElem.find(A.soundBtnSelector);var r=chatMainElem.find(A.fileStatusViewerElem);var t=true;var m=false;var y=false;var b={userId:"",name:"",imgurl:A.defaultClientImage};function n(F){var E=JSON.stringify(F);return JSON.parse(E)}h.intervalTimer=null;h.Resize=function(){var E=a(window).height()>(A.maxHeight+100)?A.maxHeight:(a(window).height()-50);d.height(E)};h.ShowSystemMessage=function(H,F,E){if(F===undefined){F=false}var G=F?"apc-show-error":"apc-show-info";if(H.length==0){D.find(".apc-msg").html(H);D.removeClass("apc-show").removeClass("apc-show-error").removeClass("apc-show-info")}else{D.find(".apc-msg").html(H);D.removeClass("apc-show-error").removeClass("apc-show-info").addClass(G).addClass("apc-show")}if(E!==undefined&&E>0){setTimeout(function(){h.ShowSystemMessage("",F,0)},E*1000)}};h.HideSystemMessage=function(){D.find(".apc-msg").html("");D.removeClass("apc-show")};h.SendMsg=function(H,E){if(H==""){return}h.LoadConfig();var F=n(j);var G=new Date();F.temp_id=z.clientIdPrefix+G.getTime();F.id="";F.msg_html=H.replace(/[\u00A0-\u9999<>\\\'\"\&]/gim,function(I){return"&#"+I.charCodeAt(0)+";"});F.senderType=E?"C":"A";F.senderImg=z.clientImg;h.AppendMessage(F,E,false);if(typeof(E)=="undefined"){E=true;F.senderType="C";h.PostAdmin({topic:"newentry",newobj:F},function(J,I){if(J.status){if(J.currentItem){a("#"+J.currentItem.temp_id).find(".apc-msg-time").html(J.currentItem.msg_time)}else{a("#"+I.temp_id).find(".apc-msg-time").html("")}h.SaveLastData(J);h.ProcessAdminResponse(J,true)}h.StartChecking()})}z.last_temp_id++;h.SaveConfig()};h.ScrolToDown=function(){var E=q.prop("scrollHeight");q.scrollTop(E)};h.ReceiveSysMsg=function(H,J,I){if(H==""){return}var G=n(j);G.temp_id=z.clientIdPrefix+z.last_temp_id;G.id="";var F="";var E="";if(typeof J=="string"){F='<div class="apc-msg-item-header">'+F+"</div>\n"}if(typeof I=="string"){E='<div class="apc-msg-item-footer">'+E+"</div>\n"}G.msg_html=F+H+E;G.senderType="S";G.senderImg="";h.AppendSystemMessage(G,J,I)};h.GetAdminMessage=function(I,G,F){if(typeof(G)=="undefined"){G=true}if(typeof(F)=="undefined"){F=false}var E=G?"apc-me":"";var K='<span class="apc-sending">'+(G&&!F?'<i class="fa fa-spin fa-circle-o-notch"></i></span>':I.msg_time);if(I.msg_html.match(/</)&&I.msg_html.match(/>/)){var J=I.msg_html.replace(/\-\-sessionkey\-\-/gim,A.chatKey)}else{var J=h.linkify(I.msg_html+"");J=J.replace("\n","<br />")}var H=' <div id="'+I.temp_id+'" data-msg-id="'+I.id+'" class="animated fadeIn apc-item apc-msg-item '+E+'">                        <div class="apc-umg">                            <img src="'+I.senderImg+'" alt="Chatimg">                        </div>                        <div class="apc-msg">'+J+'                        </div><div class="apc-msg-time"> '+K+"</div>                    </div>";return H};h.AppendMessage=function(J,G,F,E){if(typeof(G)=="undefined"){G=true}if(typeof(F)=="undefined"){F=false}if(E===undefined){E=false}if(a("#"+J.temp_id).length>0){}else{q.append(h.GetAdminMessage(J,G,F));h.ScrolToDown();if(G){h.ResetTyping()}else{h.LoadConfig();if(z.enableSound&&E&&A.audioPath!=""){try{var H=new Audio(A.audioPath);H.play()}catch(I){}}}h.SetContentEvent()}};h.setLoadMore=function(){try{var F=q.find(".apc-item:first").data("msg-id");if(F!="AAAA"&&F!==undefined){q.find(".apc-load-move").show()}else{q.find(".apc-load-move").hide()}}catch(E){}};h.GetSystemMessage=function(F){var E=' <div id="'+F.temp_id+'"  data-msg-id="'+F.id+'"  class="animated fadeIn apc-item apc-msg-sys-item">\n                        <div class="apc-msg">\n'+F.msg_html+"                        </div>\n                    </div>";return E};h.AppendSystemMessage=function(H,E){if(a("#"+H.temp_id).length>0){}else{q.append(h.GetSystemMessage(H));h.ScrolToDown();if(E===undefined){E=false}if(z.enableSound&&E&&A.audioPath!=""){try{var F=new Audio(A.audioPath);F.play()}catch(G){}}}};h.SaveConfig=function(){if(m){return}localStorage.setItem("apbd_chat_config",JSON.stringify(z))};h.SaveLastData=function(E){localStorage.setItem("apbd_chat_data",JSON.stringify(E))};h.DeleteLastData=function(){localStorage.removeItem("apbd_chat_data")};h.LoadCacheData=function(E){if(E===undefined){E=false}var G=localStorage.getItem("apbd_chat_data");if(G){var F=JSON.parse(G);if(typeof F=="object"){h.ProcessAdminResponse(F,E)}}};h.StopChecking=function(){t=true};h.SaveLastRequestTime=function(){var E=new Date();localStorage.setItem("apc_last_request",E.getTime())};h.StartChecking=function(){t=false};h.LoadConfig=function(){var F=localStorage.getItem("apbd_chat_config");if(F){var E=JSON.parse(F);if(typeof E=="object"){z=a.extend(z,E)}}};h.ClearChatData=function(){try{clearInterval(h.intervalTimer)}catch(E){}try{localStorage.removeItem("apbd_chat_config");localStorage.removeItem("apc_last_request");localStorage.removeItem("apbd_chat_data");t=true;m=true}catch(E){}};h.HasChatData=function(){try{var E=localStorage.getItem("apbd_chat_config");if(E){return true}}catch(F){}return false};h.FileStatusViewer=function(F,E){if(E==undefined){E=F!=""}if(E){r.html(F).show()}else{r.html(F).hide()}};h.PostAdmin=function(G,E,F,H){G=a.extend(z,G,{chatKey:A.chatKey,isUserTyping:c});if(A.ajaxSender){A.ajaxSender(G,E,F,H);return}if(A.url==""){return}a.ajax({type:"POST",url:A.url,data:G,dataType:"json",cache:false,async:true,beforeSend:function(){h.StopChecking();h.SaveLastRequestTime();if(typeof F=="function"){F(G)}},success:function(I){h.StartChecking();if(typeof E=="function"){E(I,G);return}},complete:function(){h.StartChecking();if(typeof H=="function"){H(G);return}}})};h.linkify=function(H){var F=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;var G=/(^|[^\/])(www\.[\S]+(\b|$))/gim;var E=/[\w.]+@[a-zA-Z_-]+?(?:\.[a-zA-Z]{2,6})+/gim;return H.replace(F,'<a href="$&" target="_blank">$&</a>').replace(G,'$1<a target="_blank" href="http://$2">$2</a>').replace(E,'<a target="_blank" href="mailto:$&">$&</a>')};h.LoadMsg=function(){if(t&&!h.HasChatData()){h.ClearChatData();return}if(t){return}else{var F=localStorage.getItem("apc_last_request");var G=new Date();var E=G.getTime()-F;if(E+1000<A.checkInterval){h.LoadCacheData();return}h.PostAdmin({topic:"checking"},function(I,H){if(I.status){if(I.isResetChatWindow){q.find(".apc-msg-item,..apc-msg-sys-item").remove();h.DeleteLastData()}z.chatId=I.id;z.clientIdPrefix=I.temp_id_prefix;if(I.clientImg!=""&&z.clientImg!=I.clientImg){q.find(".apc-msg-item.apc-umg").attr("src",I.clientImg)}if(I.clientImg!=""){z.clientImg=I.clientImg}if(z.clientId!=""&&z.clientId!=I.open_user_id){}else{z.clientId=I.open_user_id}if(I.isAdminTyping){h.ShowTyping()}else{h.HideTyping()}h.SaveConfig();h.SaveLastData(I);h.ProcessAdminResponse(I,true);h.StartChecking()}},function(H){})}};h.ProcessAdminResponse=function(G,E){try{if(G.isClosed){h.ResetChatting();h.ShowSystemMessage(G.header_msg,true,30);return}}catch(H){}if(G.chatStatus=="O"){h.ResetChatting();h.ShowSystemMessage(G.header_msg,true,30);h.ClearChatData();t=true;m=true;return}if(G.isAdminTyping){h.ShowTyping()}else{h.HideTyping()}h.SetInputboxStatus(G.isStarted);h.ShowSystemMessage(G.header_msg);if(E===undefined){E=false}for(var F=G.lastData.length-1;F>=0;F--){h.AppendMessageByObject(G.lastData[F],E)}h.setLoadMore()};h.AppendMessageByObject=function(F,E){if(E===undefined){E=false}if(F.senderType=="S"){h.AppendSystemMessage(F,E)}else{if(F.senderType=="C"){h.AppendMessage(F,true,true,E)}else{if(F.senderType=="A"){h.AppendMessage(F,false,true,E)}}}};h.HideChatWindow=function(){z.isOpened=false;t=true;h.SaveConfig();d.fadeOut("fast",function(){d.removeClass("apc-ct-open");a("body").removeClass("apc-has-cht")})};h.ShowChatWindow=function(){t=false;z.isOpened=true;h.SaveConfig();if(z.chatId!=""){h.LoadCacheData(false);h.setStartChatting()}d.addClass("apc-ct-open").fadeIn();h.ScrolToDown();l.focus();a("body").addClass("apc-has-cht")};h.ToggleChatWindow=function(){if(d.hasClass("apc-ct-open")){h.HideChatWindow()}else{h.LoadMsg();h.ShowChatWindow()}};h.ShowTyping=function(){g.show();s=true};h.setStartChatting=function(){t=false;m=false;d.removeClass("apc-not-started").addClass("apc-started");h.ResetTyping();h.intervalTimer=setInterval(h.LoadMsg,A.checkInterval)};h.ResetChatting=function(){t=true;h.ResetTyping();d.removeClass("apc-started").addClass("apc-not-started");q.html("");h.ClearChatData()};h.StartChatting=function(){h.PostAdmin({topic:"start"},function(F,E){if(F.status){z.chatId=F.id;z.clientIdPrefix=F.temp_id_prefix;z.clientImg=F.clientImg;h.SaveConfig();h.ProcessAdminResponse(F);h.setStartChatting()}},function(E){})};h.HideTyping=function(){g.hide();s=false};h.SetInputboxStatus=function(E){if(E){i.removeClass("is-disabled");l.prop("disabled",false)}else{if(!i.hasClass("is-disabled")){i.addClass("is-disabled")}l.prop("disabled",true)}};h.CheckOldChat=function(){h.LoadConfig();if(z.isOpened){h.ShowChatWindow()}};h.ResetTyping=function(){l.val("");l.trigger("keyup");l.focus();c=false};h.ToggleSoundOption=function(){if(u.hasClass("apc-enable")){h.LoadConfig();z.enableSound=false;h.SetSoundStatus(false);h.SaveConfig()}else{h.LoadConfig();z.enableSound=true;h.SetSoundStatus(true);h.SaveConfig()}};h.SetSoundStatus=function(E){if(E){u.removeClass("apc-disable").addClass("apc-enable");u.find("> i").removeClass(A.soundMuteIcon).addClass(A.soundEnableIcon)}else{u.removeClass("apc-enable").addClass("apc-disable");u.find("> i").removeClass(A.soundEnableIcon).addClass(A.soundMuteIcon)}};h.SendFile=function(F,E,G,K,J,L){var H=a("<form>");H.append(E.clone());H.append('<input value="attach" type="hidden" name="topic">');H.append('<input value="'+z.clientId+'" type="hidden" name="clientId">');H.append('<input value="'+z.chatId+'" type="hidden" name="chatId">');H.append('<input value="'+A.chatKey+'" type="hidden" name="chatKey">');var I=new FormData(H[0]);a.ajax({type:"post",url:F,data:I,dataType:"json",beforeSend:function(){if(G!==undefined&&typeof G=="function"){G()}},success:function(M){if(L!==undefined&&typeof L=="function"){L(M)}},xhr:function(){var M=a.ajaxSettings.xhr();M.upload.onprogress=function(N){var O=(N.loaded/N.total*100);if(J!==undefined&&typeof J=="function"){J(O,N.loaded,N.total)}};M.upload.onload=function(){if(K!==undefined&&typeof K=="function"){K()}};return M},processData:false,contentType:false})};h.AttachButtonStatus=function(E){if(A.isDisableFileUpload){w.hide()}if(E){w.show()}else{w.hide()}};h.AlertMessageViewer=function(L,E,H,K,G,J){if(window.apc_msg_timer!==undefined){try{clearTimeout(window.apc_msg_timer)}catch(I){}}if(E===undefined){E=true}var F=d.find(".apc-alert-msg");if(F.length<=0){F=a('<div class="apc-alert-msg"></div>');d.prepend(F)}F.html(L);if(E){F.addClass("apc-success-msg").removeClass("apc-error-msg")}else{F.addClass("apc-error-msg").removeClass("apc-success-msg")}window.apc_msg_timer=setTimeout(function(){F.removeClass("apc-success-msg").removeClass("apc-error-msg")},5000)};h.sprintf=function(F){for(var E=1;E<arguments.length;E++){F=F.replace(/%s/i,arguments[E])}return F};h.SetContentEvent=function(){try{a(".apc-chat-img:not(.added-p)").magnificPopup({type:"image",mainClass:"mfp-with-zoom",zoom:{enabled:true,duration:300,easing:"ease-in-out",opener:function(F){return F.is("img")?F:F.find("img")}}}).addClass("added-p")}catch(E){console.log(E)}};h.AddloadMoreMessageData=function(H){var G=q.find(".apc-load-move");for(var F in H.lastData){var E="";if(H.lastData[F].senderType=="S"){E=h.GetSystemMessage(H.lastData[F])}else{if(H.lastData[F].senderType=="C"){E=h.GetAdminMessage(H.lastData[F],true,true)}else{if(H.lastData[F].senderType=="A"){E=h.GetAdminMessage(H.lastData[F],false,true)}}}if(E!=""){G.after(E)}}h.SetContentEvent();h.setLoadMore()};h.init=function(){h.LoadConfig();h.Resize();a(window).on("resize",function(){h.Resize()});B.on("click",function(E){E.preventDefault();var F=l.val();h.SendMsg(F);l.val("")});l.on("keypress",function(F){var E=F.which;if(!F.shiftKey&&E==13){F.preventDefault();var G=l.val();h.SendMsg(G);l.val("")}});l.on("keyup",function(E){var F=l.val();if(F.length>0){h.AttachButtonStatus(false);c=true}else{h.AttachButtonStatus(true);c=false}});w.on("click",function(E){E.preventDefault();if(!A.isDisableFileUpload&&A.url!=""){a('<input type="file" name="attach_file" accept="'+A.fileAccepts+'">').on("change",function(J){var I=A.maxFileSize*1024*1024;var K=this.files[0].name.substr(-4);var H=a(this).attr("accept");var F=H.indexOf(K)!=-1;if(I<this.files[0].size){h.AlertMessageViewer(h.sprintf(A.maxFileErrorMsg,A.maxFileSize),false,false,A.maxFileErrorMsgTitle,"times-circle-o")}else{if(!F){h.AlertMessageViewer(A.unsupportedFileMsg,false,false,A.unsupportedFileMsgTitle,"times-circle-o")}else{var G=this.files[0].name;if(G.length>10){G=G.substr(0,5)+".."+G.substr(-5)}h.SendFile(A.url,a(this),function(){h.FileStatusViewer(G+" uploading(0%)");h.SaveLastRequestTime()},function(){h.FileStatusViewer(G+" processing..")},function(M,L,N){h.FileStatusViewer(G+" uploading("+M.toFixed(0)+"%)")},function(L){if(!L.attach_status){h.AlertMessageViewer(L.attach_msg,false)}h.FileStatusViewer("",false);h.ProcessAdminResponse(L);setTimeout(h.ScrolToDown,100)})}}}).trigger("click")}});if(A.isDisableFileUpload){h.AttachButtonStatus(false)}p.on("click",function(E){E.preventDefault();h.HideChatWindow()});q.find(".apc-load-move").on("click",function(H){try{var G=q.find(".apc-item:first").data("msg-id");var I=a(this);var F=I.find("> button i");var E=F.attr("class");h.PostAdmin({topic:"loadmore",last_msg_id:G},function(K,J){h.AddloadMoreMessageData(K)},function(J){I.find("> button i").attr("class","fa fa-spin fa-refresh")},function(){I.find("> button i").attr("class",E)})}catch(H){}});d.hide();d.removeClass("apc-ct-not-ready");v.on("click",function(E){E.preventDefault();h.ToggleChatWindow()});u.on("click",function(E){E.preventDefault();E.stopPropagation();h.ToggleSoundOption()});h.SetSoundStatus(z.enableSound);h.CheckOldChat();e.on("click",function(E){E.preventDefault();h.StartChatting()});if(a.isFunction(A.onInit)){A.onInit(h)}}();return h}})})(jQuery);